<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="
  Security Model
  #


  Security Architecture Overview
  #



  Syscall Filtering with Seccomp
  #

Python Seccomp Implementation


  实现
  #

python.go
type PythonRunner struct {
	runner.TempDirRunner
}

//go:embed prescript.py
var sandbox_fs []byte

func (p *PythonRunner) Run(
	code string,
	timeout time.Duration,
	stdin []byte,
	preload string,
	options *types.RunnerOptions,
) (chan []byte, chan []byte, chan bool, error) {
	configuration := static.GetDifySandboxGlobalConfigurations()

	// initialize the environment
	untrusted_code_path, key, err := p.InitializeEnvironment(code, preload, options)
	if err != nil {
		return nil, nil, nil, err
	}

	// capture the output
	output_handler := runner.NewOutputCaptureRunner()
	output_handler.SetTimeout(timeout)
	output_handler.SetAfterExitHook(func() {
		// remove untrusted code
		os.Remove(untrusted_code_path)
	})

	// create a new process   ### 执行python代码的进程
	cmd := exec.Command(
		configuration.PythonPath,
		untrusted_code_path,
		LIB_PATH,
		key,
	)
	cmd.Env = []string{}
	cmd.Dir = LIB_PATH

	if configuration.Proxy.Socks5 != &#34;&#34; {
		cmd.Env = append(cmd.Env, fmt.Sprintf(&#34;HTTPS_PROXY=%s&#34;, configuration.Proxy.Socks5))
		cmd.Env = append(cmd.Env, fmt.Sprintf(&#34;HTTP_PROXY=%s&#34;, configuration.Proxy.Socks5))
	} else if configuration.Proxy.Https != &#34;&#34; || configuration.Proxy.Http != &#34;&#34; {
		if configuration.Proxy.Https != &#34;&#34; {
			cmd.Env = append(cmd.Env, fmt.Sprintf(&#34;HTTPS_PROXY=%s&#34;, configuration.Proxy.Https))
		}
		if configuration.Proxy.Http != &#34;&#34; {
			cmd.Env = append(cmd.Env, fmt.Sprintf(&#34;HTTP_PROXY=%s&#34;, configuration.Proxy.Http))
		}
	}

	if len(configuration.AllowedSyscalls) &gt; 0 {
		cmd.Env = append(cmd.Env,
			fmt.Sprintf(&#34;ALLOWED_SYSCALLS=%s&#34;,
				strings.Trim(strings.Join(strings.Fields(fmt.Sprint(configuration.AllowedSyscalls)), &#34;,&#34;), &#34;[]&#34;),
			),
		)
	}

	err = output_handler.CaptureOutput(cmd)
	if err != nil {
		return nil, nil, nil, err
	}

	return output_handler.GetStdout(), output_handler.GetStderr(), output_handler.GetDone(), nil
}

func (p *PythonRunner) InitializeEnvironment(code string, preload string, options *types.RunnerOptions) (string, string, error) {
	if !checkLibAvaliable() {
		// ensure environment is reversed
		releaseLibBinary(false)
	}

	// create a tmp dir and copy the python script
	temp_code_name := strings.ReplaceAll(uuid.New().String(), &#34;-&#34;, &#34;_&#34;)
	temp_code_name = strings.ReplaceAll(temp_code_name, &#34;/&#34;, &#34;.&#34;)

    /// 把prescript.py中的placeholder都替换掉
	script := strings.Replace(
		string(sandbox_fs),
		&#34;{{uid}}&#34;, strconv.Itoa(static.SANDBOX_USER_UID), 1,
	)

	script = strings.Replace(
		script,
		&#34;{{gid}}&#34;, strconv.Itoa(static.SANDBOX_GROUP_ID), 1,
	)

	if options.EnableNetwork {
		script = strings.Replace(
			script,
			&#34;{{enable_network}}&#34;, &#34;1&#34;, 1,
		)
	} else {
		script = strings.Replace(
			script,
			&#34;{{enable_network}}&#34;, &#34;0&#34;, 1,
		)
	}

	script = strings.Replace(
		script,
		&#34;{{preload}}&#34;,
		fmt.Sprintf(&#34;%s\\n&#34;, preload),
		1,
	)

	// generate a random 512 bit key
	key_len := 64
	key := make([]byte, key_len)
	_, err := rand.Read(key)
	if err != nil {
		return &#34;&#34;, &#34;&#34;, err
	}
    /// 代码加密
	// encrypt the code  
	encrypted_code := make([]byte, len(code))
	for i := 0; i &lt; len(code); i&#43;&#43; {
		encrypted_code[i] = code[i] ^ key[i%key_len]
	}

    /// 代码做base64
	// encode code using base64 
	code = base64.StdEncoding.EncodeToString(encrypted_code)
	// encode key using base64
	encoded_key := base64.StdEncoding.EncodeToString(key)

	code = strings.Replace(
		script,
		&#34;{{code}}&#34;,
		code,
		1,
	)

	untrusted_code_path := fmt.Sprintf(&#34;%s/tmp/%s.py&#34;, LIB_PATH, temp_code_name)
	err = os.MkdirAll(path.Dir(untrusted_code_path), 0755)
	if err != nil {
		return &#34;&#34;, &#34;&#34;, err
	}
	err = os.WriteFile(untrusted_code_path, []byte(code), 0755)
	if err != nil {
		return &#34;&#34;, &#34;&#34;, err
	}

	return untrusted_code_path, encoded_key, nil
}
prescript.py">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://www6v.github.io/www6vAIGC/docs/Agent/Platform/DifySandbox/">
  <meta property="og:site_name" content="基于LLM的系统设计与实现">
  <meta property="og:title" content="(实现)Dify sandbox *">
  <meta property="og:description" content="Security Model # Security Architecture Overview # Syscall Filtering with Seccomp # Python Seccomp Implementation
实现 # python.go
type PythonRunner struct { runner.TempDirRunner } //go:embed prescript.py var sandbox_fs []byte func (p *PythonRunner) Run( code string, timeout time.Duration, stdin []byte, preload string, options *types.RunnerOptions, ) (chan []byte, chan []byte, chan bool, error) { configuration := static.GetDifySandboxGlobalConfigurations() // initialize the environment untrusted_code_path, key, err := p.InitializeEnvironment(code, preload, options) if err != nil { return nil, nil, nil, err } // capture the output output_handler := runner.NewOutputCaptureRunner() output_handler.SetTimeout(timeout) output_handler.SetAfterExitHook(func() { // remove untrusted code os.Remove(untrusted_code_path) }) // create a new process ### 执行python代码的进程 cmd := exec.Command( configuration.PythonPath, untrusted_code_path, LIB_PATH, key, ) cmd.Env = []string{} cmd.Dir = LIB_PATH if configuration.Proxy.Socks5 != &#34;&#34; { cmd.Env = append(cmd.Env, fmt.Sprintf(&#34;HTTPS_PROXY=%s&#34;, configuration.Proxy.Socks5)) cmd.Env = append(cmd.Env, fmt.Sprintf(&#34;HTTP_PROXY=%s&#34;, configuration.Proxy.Socks5)) } else if configuration.Proxy.Https != &#34;&#34; || configuration.Proxy.Http != &#34;&#34; { if configuration.Proxy.Https != &#34;&#34; { cmd.Env = append(cmd.Env, fmt.Sprintf(&#34;HTTPS_PROXY=%s&#34;, configuration.Proxy.Https)) } if configuration.Proxy.Http != &#34;&#34; { cmd.Env = append(cmd.Env, fmt.Sprintf(&#34;HTTP_PROXY=%s&#34;, configuration.Proxy.Http)) } } if len(configuration.AllowedSyscalls) &gt; 0 { cmd.Env = append(cmd.Env, fmt.Sprintf(&#34;ALLOWED_SYSCALLS=%s&#34;, strings.Trim(strings.Join(strings.Fields(fmt.Sprint(configuration.AllowedSyscalls)), &#34;,&#34;), &#34;[]&#34;), ), ) } err = output_handler.CaptureOutput(cmd) if err != nil { return nil, nil, nil, err } return output_handler.GetStdout(), output_handler.GetStderr(), output_handler.GetDone(), nil } func (p *PythonRunner) InitializeEnvironment(code string, preload string, options *types.RunnerOptions) (string, string, error) { if !checkLibAvaliable() { // ensure environment is reversed releaseLibBinary(false) } // create a tmp dir and copy the python script temp_code_name := strings.ReplaceAll(uuid.New().String(), &#34;-&#34;, &#34;_&#34;) temp_code_name = strings.ReplaceAll(temp_code_name, &#34;/&#34;, &#34;.&#34;) /// 把prescript.py中的placeholder都替换掉 script := strings.Replace( string(sandbox_fs), &#34;{{uid}}&#34;, strconv.Itoa(static.SANDBOX_USER_UID), 1, ) script = strings.Replace( script, &#34;{{gid}}&#34;, strconv.Itoa(static.SANDBOX_GROUP_ID), 1, ) if options.EnableNetwork { script = strings.Replace( script, &#34;{{enable_network}}&#34;, &#34;1&#34;, 1, ) } else { script = strings.Replace( script, &#34;{{enable_network}}&#34;, &#34;0&#34;, 1, ) } script = strings.Replace( script, &#34;{{preload}}&#34;, fmt.Sprintf(&#34;%s\\n&#34;, preload), 1, ) // generate a random 512 bit key key_len := 64 key := make([]byte, key_len) _, err := rand.Read(key) if err != nil { return &#34;&#34;, &#34;&#34;, err } /// 代码加密 // encrypt the code encrypted_code := make([]byte, len(code)) for i := 0; i &lt; len(code); i&#43;&#43; { encrypted_code[i] = code[i] ^ key[i%key_len] } /// 代码做base64 // encode code using base64 code = base64.StdEncoding.EncodeToString(encrypted_code) // encode key using base64 encoded_key := base64.StdEncoding.EncodeToString(key) code = strings.Replace( script, &#34;{{code}}&#34;, code, 1, ) untrusted_code_path := fmt.Sprintf(&#34;%s/tmp/%s.py&#34;, LIB_PATH, temp_code_name) err = os.MkdirAll(path.Dir(untrusted_code_path), 0755) if err != nil { return &#34;&#34;, &#34;&#34;, err } err = os.WriteFile(untrusted_code_path, []byte(code), 0755) if err != nil { return &#34;&#34;, &#34;&#34;, err } return untrusted_code_path, encoded_key, nil } prescript.py">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="website">
<title>(实现)Dify sandbox * | 基于LLM的系统设计与实现</title>
<link rel="icon" href="/www6vAIGC/favicon.png" >
<link rel="manifest" href="/www6vAIGC/manifest.json">
<link rel="canonical" href="https://www6v.github.io/www6vAIGC/docs/Agent/Platform/DifySandbox/">
<link rel="stylesheet" href="/www6vAIGC/book.min.6c8b9d2a1fc95075ed7da46ca81060b39add8fff6741ac51259f768929281e2c.css" integrity="sha256-bIudKh/JUHXtfaRsqBBgs5rdj/9nQaxRJZ92iSkoHiw=" crossorigin="anonymous">
  <script defer src="/www6vAIGC/fuse.min.js"></script>
  <script defer src="/www6vAIGC/en.search.min.0fa871c19a97668e250a0ed85692cf4dc493d6d4c0099cd5a9afb6c576719600.js" integrity="sha256-D6hxwZqXZo4lCg7YVpLPTcST1tTACZzVqa&#43;2xXZxlgA=" crossorigin="anonymous"></script>
<link rel="alternate" type="application/rss+xml" href="https://www6v.github.io/www6vAIGC/docs/Agent/Platform/DifySandbox/index.xml" title="基于LLM的系统设计与实现" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/www6vAIGC/"><span>基于LLM的系统设计与实现</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>















  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-bc5f0ae22069720f7a930c5c075f1c7f" class="toggle"  />
    <label for="section-bc5f0ae22069720f7a930c5c075f1c7f" class="flex justify-between">
      <a role="button" class="">RAG</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-1a0836060fdf8ba190a5fac2d0943b91" class="toggle"  />
    <label for="section-1a0836060fdf8ba190a5fac2d0943b91" class="flex justify-between">
      <a role="button" class="">Overview</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/Overview/RAG/" class="">(综述)RAG &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/Overview/RAGModularRAG/" class="">(原理)Modular RAG &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/Overview/RAGPerformance/" class="">(原理)Advanced RAG &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/Overview/RAGEval/" class="">RAG 评估</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/Overview/RAGSFT/" class="">RAG vs SFT</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-53c3fa928a6ea204801cc4f0e647e11c" class="toggle"  />
    <label for="section-53c3fa928a6ea204801cc4f0e647e11c" class="flex justify-between">
      <a role="button" class="">实战 *</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/%E5%AE%9E%E6%88%98/RAGBestPractice/" class="">(Work)RAG 最佳实践 &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/%E5%AE%9E%E6%88%98/RAG-ant/" class="">(蚂蚁)RAG</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/%E5%AE%9E%E6%88%98/RAGPractice/" class="">(实战)RAG</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/%E5%AE%9E%E6%88%98/RAGFailure/" class="">(Work)RAG 故障点 &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/%E5%AE%9E%E6%88%98/RAGOptimize/" class="">RAG 优化 *</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>framework</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/%E5%AE%9E%E6%88%98/framework/RAGFramework/" class="">RAG Framework</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/%E5%AE%9E%E6%88%98/framework/RAGchatchat/" class="">(框架)RAG Langchain-Chatchat</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/%E5%AE%9E%E6%88%98/framework/RAGQanything/" class="">(框架) Qanything</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/%E5%AE%9E%E6%88%98/framework/RAGRAGflow/" class="">(框架)RAGflow &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f983f8649ed7c18c40a527b381aa5d86" class="toggle"  />
    <label for="section-f983f8649ed7c18c40a527b381aa5d86" class="flex justify-between">
      <a role="button" class="">Pattern</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/Pattern/RAGPattern/" class="">(原理) RAG Pattern *</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Agentic RAG</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/Pattern/Agentic-RAG/AgenticRAG/" class="">(原理|实战)Agentic RAG &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/Pattern/Agentic-RAG/RAGSelfReflective/" class="">(原理|实战)Self-Reflective RAG</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>KG-RAG</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/Pattern/KG-RAG/graphRAG/" class="">GraphRAG &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/Pattern/KG-RAG/RAGKG/" class="">RAG KG</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Multimodal RAG</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/Pattern/Multimodal-RAG/RAGMultimodal/" class="">(Survey)多模态 RAG &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/Pattern/Multimodal-RAG/RAGMultimodalPractice/" class="">(实战)多模态 RAG</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-227244fb63b5d06d0aa24ee5c048c9b6" class="toggle"  />
    <label for="section-227244fb63b5d06d0aa24ee5c048c9b6" class="flex justify-between">
      <a role="button" class="">phase *</a>
    </label>
  

          
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>(Phase)index</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/phase/phaseRAGIndex/RAGIndex/" class="">(原理) Index &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/phase/phaseRAGIndex/RAGChunk/" class="">(原理|实战) Chunk &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>(Phase)pre-retrival</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/phase/phaseRAGPreRetrieval/QueryRewrite/" class="">(原理|实战)Query Rewrite</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/phase/phaseRAGPreRetrieval/QueryTransformation/" class="">(原理|实战)Query Transformation</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/phase/phaseRAGPreRetrieval/RAGRouting/" class="">(原理|实战)Query Routing</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>(Phase)post-retrieval</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/phase/phaseRAGPostRetrieval/RAGFusion/" class="">(原理|实战)RAG Fusion</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/phase/phaseRAGPostRetrieval/RAGRerank/" class="">(原理|实战)RAG Rerank</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-969e066f20490fe0eeebd25a6552fd68" class="toggle"  />
    <label for="section-969e066f20490fe0eeebd25a6552fd68" class="flex justify-between">
      <a role="button" class="">案例</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/%E6%A1%88%E4%BE%8B/RAGOpenAI/" class="">(原理)RAG OpenAI案例</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/RAG/%E6%A1%88%E4%BE%8B/RAGBaichuan/" class="">(原理)RAG Baichuan案例</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-6e2460a7a885c2c75a83ab0cd0086962" class="toggle" checked />
    <label for="section-6e2460a7a885c2c75a83ab0cd0086962" class="flex justify-between">
      <a role="button" class="">Agent</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-1290fc15a07942b153d866423d44cd39" class="toggle"  />
    <label for="section-1290fc15a07942b153d866423d44cd39" class="flex justify-between">
      <a role="button" class="">组件 *</a>
    </label>
  

          
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Reflection</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/%E7%BB%84%E4%BB%B6/Reflection/AgentReflection/" class="">Reflection Agent *</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Planning</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/%E7%BB%84%E4%BB%B6/Planning/AgentPlanning/" class="">Agent Planning</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/%E7%BB%84%E4%BB%B6/Planning/COT/" class="">(原理)COT</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/%E7%BB%84%E4%BB%B6/Planning/AgentPlanAndExecute/" class="">(Work|实战)Plan&amp;Execute,ReWOO</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Memory</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/%E7%BB%84%E4%BB%B6/Memory/AgentMemory/" class="">Agent  Memory &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Tool use</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/%E7%BB%84%E4%BB%B6/Tool-use/FunctionCall/" class="">(原理|实战) [OpenAI]Function Call</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/%E7%BB%84%E4%BB%B6/Tool-use/AgentTuning/" class="">(实战)Agent Tuning</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/%E7%BB%84%E4%BB%B6/Tool-use/AgentToolGorilla/" class="">(Work)[SFT]Gorilla</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/%E7%BB%84%E4%BB%B6/Tool-use/AgentToolformer/" class="">(Work)[SFT]Toolformer</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/%E7%BB%84%E4%BB%B6/Tool-use/AgentTool/" class="">(Work)Agent-Tools</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-bd0290ddab8edf698cb67507a6e74b97" class="toggle"  />
    <label for="section-bd0290ddab8edf698cb67507a6e74b97" class="flex justify-between">
      <a role="button" class="">Overview</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Overview/Agent/" class="">(原理)Agent 架构 &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Overview/AgentGuide/" class="">(原理) Agent Guide &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Overview/AgentCategory/" class="">(原理)Agent 分类[有趣|有用]</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b757002e9620728c23883bffd127cb72" class="toggle" checked />
    <label for="section-b757002e9620728c23883bffd127cb72" class="flex justify-between">
      <a role="button" class="">Platform *</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Platform/Dify/" class="">(实现)Dify *</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Platform/DifySandbox/" class="active">(实现)Dify sandbox *</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Platform/Dify-deploy/" class="">(实践)Dify 生产部署 *</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Platform/AgentList/" class="">(List)Agent 产品 平台</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-5b26accdda8a68c7dc414030c1c0fd5c" class="toggle"  />
    <label for="section-5b26accdda8a68c7dc414030c1c0fd5c" class="flex justify-between">
      <a role="button" class="">Practice</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Practice/AgentOpt/" class="">(Survey) Agent 优化 &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Practice/AgentPractice/" class="">(实战)Agent</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Practice/AgentChallenge/" class="">(原理)Agent Challenge</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Practice/Agent12Factor/" class="">Agent 12-Factor &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0b800a1752a4e836473ce3e89db51e41" class="toggle"  />
    <label for="section-0b800a1752a4e836473ce3e89db51e41" class="flex justify-between">
      <a role="button" class="">Multi-agent *</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Multi-agent/MultiAgents/" class="">(原理)Multi-Agents &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Multi-agent/MultiAgentsPractice/" class="">(实战)LangGraph</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Multi-agent/MultiAgentsFail/" class="">Multi-Agent  Fail &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Multi-agent/AgentAutogen/" class="">(原理&amp;实战)AutoGen &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-5f9213ddeaf6f028a8744dae5ff54e6c" class="toggle"  />
    <label for="section-5f9213ddeaf6f028a8744dae5ff54e6c" class="flex justify-between">
      <a role="button" class="">Communication *</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Communication/MCPSurvey/" class="">(综述)MCP &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Communication/MCP/" class="">(原理|实战)MCP &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Communication/MCPArch/" class="">(原理)MCP 架构</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Agent/Communication/MCPManyTools/" class="">(原理|实现)MCP 大量工具调用 &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-5e965576d91fb4c69aa61a2f3a9f8bf3" class="toggle"  />
    <label for="section-5e965576d91fb4c69aa61a2f3a9f8bf3" class="flex justify-between">
      <a role="button" class="">FineTuning</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-80bdfd9000177aee275c9503498f92ab" class="toggle"  />
    <label for="section-80bdfd9000177aee275c9503498f92ab" class="flex justify-between">
      <a role="button" class="">Instruct Tuning</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/Instruct-Tuning/InstructTuning/" class="">(原理)Instruct Tuning</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/Instruct-Tuning/InstructTuningSurvey/" class="">(Survey)Instruct Tuning</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-9b9e0f2329fcde1ff80c7bad22d19d8c" class="toggle"  />
    <label for="section-9b9e0f2329fcde1ff80c7bad22d19d8c" class="flex justify-between">
      <a role="button" class="">实践 *</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/%E5%AE%9E%E8%B7%B5/FineTuningBestPractice/" class="">(最佳实践)SFT  &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/%E5%AE%9E%E8%B7%B5/FineTuningWhen/" class="">(原理)Fine-Tuning 时机</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/%E5%AE%9E%E8%B7%B5/FineTuningBert/" class="">Fine Tuning-Bert</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-60ef828f1779f643d1df0918fdc102ac" class="toggle"  />
    <label for="section-60ef828f1779f643d1df0918fdc102ac" class="flex justify-between">
      <a role="button" class="">PEFT *</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/PEFT/FineTuning/" class="">(原理)PEFT &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/PEFT/FineTuningPEFT/" class="">(实战)PEFT 概述</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Soft Prompt</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/PEFT/Soft-Prompt/PromptTuning/" class="">(原理)Prompt Tuning</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/PEFT/Soft-Prompt/PEFTPtuning/" class="">P-Tuning</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/PEFT/Soft-Prompt/PEFTPtuningPractice/" class="">(实战)PEFT P-Tuning</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/PEFT/Soft-Prompt/PromptTuningPractice/" class="">(实战)PromptTuning</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Lora</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/PEFT/Lora/PEFTQLora/" class="">(原理|实战) QLoRA *</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/PEFT/Lora/PEFTLora/" class="">(实战) Lora &#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-9f31ef3af6246464fc33089e29fb0307" class="toggle"  />
    <label for="section-9f31ef3af6246464fc33089e29fb0307" class="flex justify-between">
      <a role="button" class="">Data</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>Data Quality</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>Instruction Quality</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/Data/Data-Quality/Instruction-Quality/DataSFTQuality/" class="">(原理)LIMA, LESS</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Instruction Diversity</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/Data/Data-Quality/Instruction-Diversity/SelfInstruct/" class="">(原理)SELF-INSTRUCT&#43;</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/Data/Data-Quality/Instruction-Diversity/DataSelfQA/" class="">(原理|实战)Self-QA *</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Instruction Complexity</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/Data/Data-Quality/Instruction-Complexity/DataWizard/" class="">(原理)Wizard</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Task composition</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/Data/Task-composition/DatasetSFT/" class="">(原理)SFT 数据组合 *</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/Data/DataSFTScaling/" class="">(原理)SFT Scaling</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/Data/DataSelection/" class="">(原理)Data Selection</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/FineTuning/Data/DatasetSFTList/" class="">(List)SFT数据集</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-6ca7a84f92bd02461b43875ea395a9d3" class="toggle"  />
    <label for="section-6ca7a84f92bd02461b43875ea395a9d3" class="flex justify-between">
      <a role="button" class="">文档智能</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/DocumentAI/MinerU/" class="">MinerU</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/DocumentAI/DocumentAI/" class="">文档智能</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/DocumentAI/Table/" class="">表格</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-91fcdf5001be732237a99b9825d96186" class="toggle"  />
    <label for="section-91fcdf5001be732237a99b9825d96186" class="flex justify-between">
      <a role="button" class="">Prompt Engineering</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Prompt-Engineering/Prompting101/" class="">(原理) 谷歌 Prompting guide 101 *</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Prompt-Engineering/PromptEngineering/" class="">(原理)Prompt Engineering</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Prompt-Engineering/PromptingClaude/" class="">(实践)Prompting Claude *</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Prompt-Engineering/PromptCode/" class="">(原理)[Prompting]Coding</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Prompt-Engineering/Prompt/" class="">(原理)[Prompting]How to use</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Prompt-Engineering/PromptingGrok/" class="">(原理)Grok 提示框架</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-f836a52581085b952fb6dd532022dfb8" class="toggle"  />
    <label for="section-f836a52581085b952fb6dd532022dfb8" class="flex justify-between">
      <a role="button" class="">Langchain</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Langchain/Langchain/" class="">Langchain</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Langchain/Retrievers/" class="">Retrievers</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Langchain/LangchainAgent/" class="">Langchain  Agent</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-1669c1145df15c970068d5a332134846" class="toggle"  />
    <label for="section-1669c1145df15c970068d5a332134846" class="flex justify-between">
      <a role="button" class="">Context Engineering</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Context-Engineering/context-engineering/" class="">(Manus)context engineering</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-12efb1db778cdc137122c32356d4feb3" class="toggle"  />
    <label for="section-12efb1db778cdc137122c32356d4feb3" class="flex justify-between">
      <a role="button" class="">Application</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Application/gpt/" class="">GPT-工具和应用</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Application/VectorStore/" class="">向量数据库</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>NL2SQL</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Application/NL2SQL/NL2SQL/" class="">NL2SQL</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Application/NL2SQL/survey/" class="">(survey)NL2SQL</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Application/NL2SQL/chatBI-Ant/" class="">(蚂蚁)chatbi</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Application/NL2SQL/opensource/" class="">(开源)NL2SQL</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-9b20c542192027a8424b70ab6515ddfd" class="toggle"  />
    <label for="section-9b20c542192027a8424b70ab6515ddfd" class="flex justify-between">
      <a role="button" class="">DeepResearch</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <span>实现</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Deep-Research/%E5%AE%9E%E7%8E%B0/DeepResearch/" class="">(原理&amp;实战)Deep Research</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Deep-Research/%E5%AE%9E%E7%8E%B0/DeepResearchJina/" class="">(原理|实现){Jina}Deep Research</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Deep-Research/%E5%AE%9E%E7%8E%B0/DeepresearchGoogle/" class="">(Google)Deep Research</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Deep-Research/%E5%AE%9E%E7%8E%B0/DeepresearchLanggraph/" class="">(Langgraph)Deep Research</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Deep-Research/%E5%AE%9E%E7%8E%B0/OpenManus/" class="">(实现)OpenManus *</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/Deep-Research/%E5%AE%9E%E7%8E%B0/researchSystem/" class="">(实践)Research system[Anthropic]</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-d370072df9ae4dfa196d449144ec75a3" class="toggle"  />
    <label for="section-d370072df9ae4dfa196d449144ec75a3" class="flex justify-between">
      <a role="button" class="">其他</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/www6vAIGC/docs/%E5%85%B6%E4%BB%96/self-work/" class="">自己的工作</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>














</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/www6vAIGC/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>(实现)Dify sandbox *</h3>

  <label for="toc-control">
    
    <img src="/www6vAIGC/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#security-model"><strong>Security Model</strong></a>
      <ul>
        <li>
          <ul>
            <li><a href="#security-architecture-overview"><strong>Security Architecture Overview</strong></a></li>
            <li><a href="#syscall-filtering-with-seccomp"><strong>Syscall Filtering with Seccomp</strong></a></li>
            <li><a href="#实现">实现</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="security-model">
  <strong>Security Model</strong>
  <a class="anchor" href="#security-model">#</a>
</h1>
<h3 id="security-architecture-overview">
  <strong>Security Architecture Overview</strong>
  <a class="anchor" href="#security-architecture-overview">#</a>
</h3>
<p><img src="./images/security.png" alt="security.png" /></p>
<h3 id="syscall-filtering-with-seccomp">
  <strong>Syscall Filtering with Seccomp</strong>
  <a class="anchor" href="#syscall-filtering-with-seccomp">#</a>
</h3>
<p><strong>Python Seccomp Implementation</strong></p>
<p><img src="./images/python-seccomp.png" alt="python-seccomp.png" /></p>
<h3 id="实现">
  实现
  <a class="anchor" href="#%e5%ae%9e%e7%8e%b0">#</a>
</h3>
<p><a href="https://github.com/langgenius/dify-sandbox/blob/main/internal/core/runner/python/python.go">python.go</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">PythonRunner</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">runner</span>.<span style="color:#a6e22e">TempDirRunner</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//go:embed prescript.py</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sandbox_fs</span> []<span style="color:#66d9ef">byte</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PythonRunner</span>) <span style="color:#a6e22e">Run</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">code</span> <span style="color:#66d9ef">string</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">timeout</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">stdin</span> []<span style="color:#66d9ef">byte</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">preload</span> <span style="color:#66d9ef">string</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">options</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">RunnerOptions</span>,
</span></span><span style="display:flex;"><span>) (<span style="color:#66d9ef">chan</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">chan</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">configuration</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">static</span>.<span style="color:#a6e22e">GetDifySandboxGlobalConfigurations</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// initialize the environment</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">untrusted_code_path</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">InitializeEnvironment</span>(<span style="color:#a6e22e">code</span>, <span style="color:#a6e22e">preload</span>, <span style="color:#a6e22e">options</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// capture the output</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">output_handler</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runner</span>.<span style="color:#a6e22e">NewOutputCaptureRunner</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">output_handler</span>.<span style="color:#a6e22e">SetTimeout</span>(<span style="color:#a6e22e">timeout</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">output_handler</span>.<span style="color:#a6e22e">SetAfterExitHook</span>(<span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// remove untrusted code</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">untrusted_code_path</span>)
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// create a new process   ### 执行python代码的进程</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">configuration</span>.<span style="color:#a6e22e">PythonPath</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">untrusted_code_path</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">LIB_PATH</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">key</span>,
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Env</span> = []<span style="color:#66d9ef">string</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Dir</span> = <span style="color:#a6e22e">LIB_PATH</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">configuration</span>.<span style="color:#a6e22e">Proxy</span>.<span style="color:#a6e22e">Socks5</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Env</span> = append(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Env</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;HTTPS_PROXY=%s&#34;</span>, <span style="color:#a6e22e">configuration</span>.<span style="color:#a6e22e">Proxy</span>.<span style="color:#a6e22e">Socks5</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Env</span> = append(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Env</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;HTTP_PROXY=%s&#34;</span>, <span style="color:#a6e22e">configuration</span>.<span style="color:#a6e22e">Proxy</span>.<span style="color:#a6e22e">Socks5</span>))
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">configuration</span>.<span style="color:#a6e22e">Proxy</span>.<span style="color:#a6e22e">Https</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">configuration</span>.<span style="color:#a6e22e">Proxy</span>.<span style="color:#a6e22e">Http</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">configuration</span>.<span style="color:#a6e22e">Proxy</span>.<span style="color:#a6e22e">Https</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Env</span> = append(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Env</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;HTTPS_PROXY=%s&#34;</span>, <span style="color:#a6e22e">configuration</span>.<span style="color:#a6e22e">Proxy</span>.<span style="color:#a6e22e">Https</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">configuration</span>.<span style="color:#a6e22e">Proxy</span>.<span style="color:#a6e22e">Http</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Env</span> = append(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Env</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;HTTP_PROXY=%s&#34;</span>, <span style="color:#a6e22e">configuration</span>.<span style="color:#a6e22e">Proxy</span>.<span style="color:#a6e22e">Http</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">configuration</span>.<span style="color:#a6e22e">AllowedSyscalls</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Env</span> = append(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Env</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;ALLOWED_SYSCALLS=%s&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Trim</span>(<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Fields</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprint</span>(<span style="color:#a6e22e">configuration</span>.<span style="color:#a6e22e">AllowedSyscalls</span>)), <span style="color:#e6db74">&#34;,&#34;</span>), <span style="color:#e6db74">&#34;[]&#34;</span>),
</span></span><span style="display:flex;"><span>			),
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">output_handler</span>.<span style="color:#a6e22e">CaptureOutput</span>(<span style="color:#a6e22e">cmd</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">output_handler</span>.<span style="color:#a6e22e">GetStdout</span>(), <span style="color:#a6e22e">output_handler</span>.<span style="color:#a6e22e">GetStderr</span>(), <span style="color:#a6e22e">output_handler</span>.<span style="color:#a6e22e">GetDone</span>(), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">PythonRunner</span>) <span style="color:#a6e22e">InitializeEnvironment</span>(<span style="color:#a6e22e">code</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">preload</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">options</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">RunnerOptions</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">checkLibAvaliable</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ensure environment is reversed</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">releaseLibBinary</span>(<span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// create a tmp dir and copy the python script</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">temp_code_name</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">ReplaceAll</span>(<span style="color:#a6e22e">uuid</span>.<span style="color:#a6e22e">New</span>().<span style="color:#a6e22e">String</span>(), <span style="color:#e6db74">&#34;-&#34;</span>, <span style="color:#e6db74">&#34;_&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">temp_code_name</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">ReplaceAll</span>(<span style="color:#a6e22e">temp_code_name</span>, <span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#e6db74">&#34;.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// 把prescript.py中的placeholder都替换掉</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">script</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(
</span></span><span style="display:flex;"><span>		string(<span style="color:#a6e22e">sandbox_fs</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;{{uid}}&#34;</span>, <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">static</span>.<span style="color:#a6e22e">SANDBOX_USER_UID</span>), <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">script</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">script</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;{{gid}}&#34;</span>, <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">static</span>.<span style="color:#a6e22e">SANDBOX_GROUP_ID</span>), <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">EnableNetwork</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">script</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">script</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;{{enable_network}}&#34;</span>, <span style="color:#e6db74">&#34;1&#34;</span>, <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">script</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">script</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;{{enable_network}}&#34;</span>, <span style="color:#e6db74">&#34;0&#34;</span>, <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">script</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">script</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;{{preload}}&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s\\n&#34;</span>, <span style="color:#a6e22e">preload</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// generate a random 512 bit key</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">key_len</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">key_len</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">key</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// 代码加密</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// encrypt the code  </span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">encrypted_code</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(<span style="color:#a6e22e">code</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; len(<span style="color:#a6e22e">code</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">encrypted_code</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">code</span>[<span style="color:#a6e22e">i</span>] ^ <span style="color:#a6e22e">key</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">%</span><span style="color:#a6e22e">key_len</span>]
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// 代码做base64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// encode code using base64 </span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">code</span> = <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">StdEncoding</span>.<span style="color:#a6e22e">EncodeToString</span>(<span style="color:#a6e22e">encrypted_code</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// encode key using base64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">encoded_key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">base64</span>.<span style="color:#a6e22e">StdEncoding</span>.<span style="color:#a6e22e">EncodeToString</span>(<span style="color:#a6e22e">key</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">code</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">script</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;{{code}}&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">code</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">untrusted_code_path</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s/tmp/%s.py&#34;</span>, <span style="color:#a6e22e">LIB_PATH</span>, <span style="color:#a6e22e">temp_code_name</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">MkdirAll</span>(<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">Dir</span>(<span style="color:#a6e22e">untrusted_code_path</span>), <span style="color:#ae81ff">0755</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">WriteFile</span>(<span style="color:#a6e22e">untrusted_code_path</span>, []byte(<span style="color:#a6e22e">code</span>), <span style="color:#ae81ff">0755</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">untrusted_code_path</span>, <span style="color:#a6e22e">encoded_key</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><a href="https://github.com/langgenius/dify-sandbox/blob/main/internal/core/runner/python/prescript.py">prescript.py</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> ctypes
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> traceback
</span></span><span style="display:flex;"><span><span style="color:#75715e"># setup sys.excepthook</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">excepthook</span>(type, value, tb):
</span></span><span style="display:flex;"><span>    sys<span style="color:#f92672">.</span>stderr<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join(traceback<span style="color:#f92672">.</span>format_exception(type, value, tb)))
</span></span><span style="display:flex;"><span>    sys<span style="color:#f92672">.</span>stderr<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span>    sys<span style="color:#f92672">.</span>exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sys<span style="color:#f92672">.</span>excepthook <span style="color:#f92672">=</span> excepthook
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lib <span style="color:#f92672">=</span> ctypes<span style="color:#f92672">.</span>CDLL(<span style="color:#e6db74">&#34;./python.so&#34;</span>)
</span></span><span style="display:flex;"><span>lib<span style="color:#f92672">.</span>DifySeccomp<span style="color:#f92672">.</span>argtypes <span style="color:#f92672">=</span> [ctypes<span style="color:#f92672">.</span>c_uint32, ctypes<span style="color:#f92672">.</span>c_uint32, ctypes<span style="color:#f92672">.</span>c_bool]
</span></span><span style="display:flex;"><span>lib<span style="color:#f92672">.</span>DifySeccomp<span style="color:#f92672">.</span>restype <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># get running path</span>
</span></span><span style="display:flex;"><span>running_path <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> running_path:
</span></span><span style="display:flex;"><span>    exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># get decrypt key</span>
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> key:
</span></span><span style="display:flex;"><span>    exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> base64 <span style="color:#f92672">import</span> b64decode
</span></span><span style="display:flex;"><span>key <span style="color:#f92672">=</span> b64decode(key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>chdir(running_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{{preload}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lib<span style="color:#f92672">.</span>DifySeccomp({{uid}}, {{gid}}, {{enable_network}})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>code <span style="color:#f92672">=</span> b64decode(<span style="color:#e6db74">&#34;{{code}}&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decrypt</span>(code, key):
</span></span><span style="display:flex;"><span>    key_len <span style="color:#f92672">=</span> len(key)
</span></span><span style="display:flex;"><span>    code_len <span style="color:#f92672">=</span> len(code)
</span></span><span style="display:flex;"><span>    code <span style="color:#f92672">=</span> bytearray(code)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(code_len):
</span></span><span style="display:flex;"><span>        code[i] <span style="color:#f92672">=</span> code[i] <span style="color:#f92672">^</span> key[i <span style="color:#f92672">%</span> key_len]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> bytes(code)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>code <span style="color:#f92672">=</span> decrypt(code, key)
</span></span><span style="display:flex;"><span>exec(code)
</span></span></code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#security-model"><strong>Security Model</strong></a>
      <ul>
        <li>
          <ul>
            <li><a href="#security-architecture-overview"><strong>Security Architecture Overview</strong></a></li>
            <li><a href="#syscall-filtering-with-seccomp"><strong>Syscall Filtering with Seccomp</strong></a></li>
            <li><a href="#实现">实现</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












